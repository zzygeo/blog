import{_ as p,c as t,b as a,a as l,d as n,e as i,f as o,r as c,o as u}from"./app-BpUWo912.js";const r={};function d(k,s){const e=c("RouteLink");return u(),t("div",null,[s[3]||(s[3]=a(`<h2 id="思路" tabindex="-1"><a class="header-anchor" href="#思路"><span>思路</span></a></h2><p>把elastic search当作mysql去学习，就比较清晰了。</p><p><strong>创建表、增删改查、客户端调用es</strong>等就是最基本的功能了。</p><h2 id="索引" tabindex="-1"><a class="header-anchor" href="#索引"><span>索引</span></a></h2><h3 id="正向索引" tabindex="-1"><a class="header-anchor" href="#正向索引"><span>正向索引</span></a></h3><p>拿着书籍的目录去找页码，这样的场景就是正向索引。</p><h3 id="倒排索引" tabindex="-1"><a class="header-anchor" href="#倒排索引"><span>倒排索引</span></a></h3><p>elastic会将输入的文字进行分词，例如：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">你好，大熊猫 =&gt; 你好|大熊猫</span>
<span class="line">你好，java =&gt; 你好|java</span>
<span class="line">早上好，大熊猫 =&gt; 早上好|大熊猫</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>根据分词结果构建索引表，记录文本信息。</p><table><thead><tr><th>索引</th><th>文章</th></tr></thead><tbody><tr><td>你好</td><td>A、B</td></tr><tr><td>大熊猫</td><td>A、C</td></tr><tr><td>java</td><td>B</td></tr><tr><td>早上好</td><td>C</td></tr></tbody></table><p>在进行搜索的时候，先分词以后，然后去查询索引表，查出文章的信息。</p><h2 id="调用方式" tabindex="-1"><a class="header-anchor" href="#调用方式"><span>调用方式</span></a></h2><h3 id="http请求" tabindex="-1"><a class="header-anchor" href="#http请求"><span>http请求</span></a></h3><p>简单的请求可以直接使用curl的方式进行调用</p><h3 id="kibana" tabindex="-1"><a class="header-anchor" href="#kibana"><span>kibana</span></a></h3><p>直接使用kibana的devtools进行调用，在生产环境一般不使用。</p><h3 id="客户端" tabindex="-1"><a class="header-anchor" href="#客户端"><span>客户端</span></a></h3><p>主要有三种：</p><ol><li>elastic search官网的<a href="https://www.elastic.co/guide/en/elasticsearch/client/java-api-client/current/index.html" target="_blank" rel="noopener noreferrer">java client</a></li><li>elastic search8舍弃的<a href="https://www.elastic.co/guide/en/elasticsearch/client/java-api/current/transport-client.html" target="_blank" rel="noopener noreferrer">Transport Client</a></li><li>spring-data系列的<a href="https://docs.spring.io/spring-data/elasticsearch/docs/4.4.14/reference/html/#reference" target="_blank" rel="noopener noreferrer">spring-data-elasticsearch</a></li></ol><p>建议使用spring-data-elasticsearch，具体移步<a href="#java%E9%87%8C%E9%9B%86%E6%88%90">java里集成章节</a>。</p><h2 id="使用-dsl" tabindex="-1"><a class="header-anchor" href="#使用-dsl"><span>使用（DSL）</span></a></h2><h3 id="插入数据并创建文档" tabindex="-1"><a class="header-anchor" href="#插入数据并创建文档"><span>插入数据并创建文档</span></a></h3><p>这种带有@timestamp和event字段的数据是ecs的数据类型，可以更好的记录事件（如日志），它的查询和普通的查询不相同。</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line">POST logs-my_app-default/_doc</span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;zzy&quot;</span></span>
<span class="line">  <span class="token property">&quot;@timestamp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2099-05-06T16:21:15.000Z&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;event&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;original&quot;</span><span class="token operator">:</span> <span class="token string">&quot;192.0.2.42 - - [06/May/2099:16:21:15 +0000] \\&quot;GET /images/bg.jpg HTTP/1.0\\&quot; 200 24736&quot;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="查询文档" tabindex="-1"><a class="header-anchor" href="#查询文档"><span>查询文档</span></a></h3><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line">GET logs-my_app-default/_search</span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;match_all&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;sort&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;@timestamp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;desc&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="查询部分字段数据" tabindex="-1"><a class="header-anchor" href="#查询部分字段数据"><span>查询部分字段数据</span></a></h3><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line">GET logs-my_app-default/_search</span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;match_all&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;fields&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token string">&quot;@timestamp&quot;</span></span>
<span class="line">  <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;_source&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;sort&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;@timestamp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;desc&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="删除文档" tabindex="-1"><a class="header-anchor" href="#删除文档"><span>删除文档</span></a></h3><p>删除文档及索引</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">DELETE _data_stream/logs-my_app-default </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>删除文档</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">DELETE {document}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="查询单条数据" tabindex="-1"><a class="header-anchor" href="#查询单条数据"><span>查询单条数据</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">GET post/_doc/{id}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="修改单条数据" tabindex="-1"><a class="header-anchor" href="#修改单条数据"><span>修改单条数据</span></a></h3><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line">POST post/_doc/v4In15IBQ7S0DDlRGJi0</span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tyt&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="查询表结构" tabindex="-1"><a class="header-anchor" href="#查询表结构"><span>查询表结构</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">GET post/_mapping</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="eql" tabindex="-1"><a class="header-anchor" href="#eql"><span>EQL</span></a></h2><p>elastic search 的 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/eql.html" target="_blank" rel="noopener noreferrer">EQL</a>（Event Query Language）查询是一种用于分析日志和时间序列数据的查询语言。</p><p><strong>eql查询主要针对ecs文档结构</strong>。</p><h2 id="sql" tabindex="-1"><a class="header-anchor" href="#sql"><span>SQL</span></a></h2><p>elastic search还支持像sql一样的查询语句，<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/query-dsl.html" target="_blank" rel="noopener noreferrer">sql查询</a></p><p><strong>可能需要额外插件支持，解析sql可能会带来性能问题</strong>。</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line">post /_sql?format=txt</span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token string">&quot;select * from post where name like &#39;%鱼%&#39;&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="painless" tabindex="-1"><a class="header-anchor" href="#painless"><span>painless</span></a></h2><p>编程式取值，比较灵活，但是学习成本高。</p><h2 id="mapping" tabindex="-1"><a class="header-anchor" href="#mapping"><span>mapping</span></a></h2><p>mapping类似mysql里的表，在elastic里，mapping描述了怎么组合一个文档。</p><h3 id="动态mapping" tabindex="-1"><a class="header-anchor" href="#动态mapping"><span>动态mapping</span></a></h3><p>mapping是动态结构，可以改变，添加一个包含新字段的数据进去，mapping结构发生改变了。</p><h3 id="显式mapping" tabindex="-1"><a class="header-anchor" href="#显式mapping"><span>显式mapping</span></a></h3><p>在创建文档的时候，也可以指定mapping。</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line">PUT /post</span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;age&quot;</span><span class="token operator">:</span>    <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;integer&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>  </span>
<span class="line">      <span class="token property">&quot;email&quot;</span><span class="token operator">:</span>  <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span> </span>
<span class="line">      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span>   <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span>  <span class="token punctuation">}</span>     </span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="分词器" tabindex="-1"><a class="header-anchor" href="#分词器"><span>分词器</span></a></h2><h3 id="空格分词器" tabindex="-1"><a class="header-anchor" href="#空格分词器"><span>空格分词器</span></a></h3><p>得到[&#39;The&#39;, &#39;quick&#39;, &#39;brown&#39;, &#39;fox&#39;]词组。</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line">POST _analyze</span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;whitespace&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;text&quot;</span><span class="token operator">:</span>     <span class="token string">&quot;The quick brown fox.&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="标准分词规则" tabindex="-1"><a class="header-anchor" href="#标准分词规则"><span>标准分词规则</span></a></h3><p>指定了一些<strong>过滤器</strong>，将大写转小写，韵母折叠。最后得到的结果是这样的。 [&#39;is&#39;, &#39;this&#39;, &#39;deja&#39;, &#39;vu&#39;]</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line">POST _analyze</span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;tokenizer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;standard&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;filter&quot;</span><span class="token operator">:</span>  <span class="token punctuation">[</span> <span class="token string">&quot;lowercase&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;asciifolding&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;text&quot;</span><span class="token operator">:</span>      <span class="token string">&quot;Is this déja vu?&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="给特定字段指定分词器" tabindex="-1"><a class="header-anchor" href="#给特定字段指定分词器"><span>给特定字段指定分词器</span></a></h3><p>下面的语句创建了一个文档，并且给字段指定了分词器。</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line">PUT my-index<span class="token number">-000001</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;settings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;analysis&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;std_folded&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> </span>
<span class="line">          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;custom&quot;</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token property">&quot;tokenizer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;standard&quot;</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token property">&quot;filter&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">            <span class="token string">&quot;lowercase&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&quot;asciifolding&quot;</span></span>
<span class="line">          <span class="token punctuation">]</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;my_text&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;std_folded&quot;</span> </span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">GET my-index<span class="token number">-000001</span>/_analyze </span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;std_folded&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">  <span class="token property">&quot;text&quot;</span><span class="token operator">:</span>     <span class="token string">&quot;Is this déjà vu?&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ik分词器-中文" tabindex="-1"><a class="header-anchor" href="#ik分词器-中文"><span>ik分词器（中文）</span></a></h3><p><a href="https://github.com/infinilabs/analysis-ik" target="_blank" rel="noopener noreferrer">analysis-ik</a>, <strong>ik_smart</strong>分词规则是智能分词，将句子分成最像词语的情况，<strong>ik_max_word</strong>是按最大粒度去分词，尽可能多的分出词语来。</p><h2 id="打分机制" tabindex="-1"><a class="header-anchor" href="#打分机制"><span>打分机制</span></a></h2><p>假如有三条内容：</p><ol><li>小王是狗</li><li>小王是长颈鹿</li><li>你是长颈鹿</li></ol><p>当搜索小王的时候，1会胜出，因为第一条不仅匹配了关键词而且句子更短。</p><p>当搜索小王，长颈鹿时，2 &gt; 3 &gt; 1。</p><p>如何计算文档相关性得分并排序，参考<a href="https://lanffy.github.io/2019/05/08/Elasticsearch-Search-Score-Algorithm" target="_blank" rel="noopener noreferrer">相关性排序算法</a>。</p><h2 id="java里集成" tabindex="-1"><a class="header-anchor" href="#java里集成"><span>java里集成</span></a></h2><h3 id="elasticsearchrepository方式" tabindex="-1"><a class="header-anchor" href="#elasticsearchrepository方式"><span>ElasticsearchRepository方式</span></a></h3><p>直接集成ElasticsearchRepository这个接口，调用现成的方法或者按它的命名规则创建的方法，即可查询到数据。</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">PostRepository</span> <span class="token keyword">extends</span> <span class="token class-name">ElasticsearchRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Post</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Post</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByTitle</span><span class="token punctuation">(</span><span class="token class-name">String</span> title<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试例子：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@SpringBootTest</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">LearnElasticsearchApplicationTests</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Resource</span></span>
<span class="line">    <span class="token class-name">PostRepository</span> postRepository<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Test</span></span>
<span class="line">    <span class="token keyword">void</span> <span class="token function">testSave</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Post</span> post <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        post<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">2L</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        post<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span><span class="token string">&quot;今天要学习&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        post<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span><span class="token string">&quot;今天学习的是数学&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        post<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span><span class="token number">2L</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        post<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        post<span class="token punctuation">.</span><span class="token function">setUpdateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Post</span> post1 <span class="token operator">=</span> postRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>post<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>post1<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Test</span></span>
<span class="line">    <span class="token keyword">void</span> <span class="token function">testFindAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Post</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> postRepository<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token class-name">PageRequest</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">Sort</span><span class="token punctuation">.</span><span class="token function">by</span><span class="token punctuation">(</span><span class="token class-name">Sort<span class="token punctuation">.</span>Direction</span><span class="token punctuation">.</span><span class="token constant">DESC</span><span class="token punctuation">,</span> <span class="token string">&quot;createTime&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Test</span></span>
<span class="line">    <span class="token keyword">void</span> <span class="token function">findByTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Post</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> postRepository<span class="token punctuation">.</span><span class="token function">findByTitle</span><span class="token punctuation">(</span><span class="token string">&quot;学习&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="eleasticsearchtemplate方式" tabindex="-1"><a class="header-anchor" href="#eleasticsearchtemplate方式"><span>EleasticsearchTemplate方式</span></a></h3><p>elasticsearchtemplate提供了更加灵活的查询，它的编写是基于dsl语法来构建的。</p><p>比如我有以下的dsl语句：</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line">GET post/_search</span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;must&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">          <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;今天&quot;</span></span>
<span class="line">          <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">          <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token property">&quot;content&quot;</span><span class="token operator">:</span> <span class="token string">&quot;数学&quot;</span></span>
<span class="line">          <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;_source&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;title&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;userId&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;sort&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;order&quot;</span><span class="token operator">:</span> <span class="token string">&quot;desc&quot;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;_score&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;order&quot;</span><span class="token operator">:</span> <span class="token string">&quot;desc&quot;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以elasticsearchtemplate的写法构建：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Service</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PostSearch</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">ElasticsearchRestTemplate</span> elasticsearchTemplate<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Post</span><span class="token punctuation">&gt;</span></span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token class-name">Post</span> post<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">String</span> title <span class="token operator">=</span> post<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">String</span> content <span class="token operator">=</span> post<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// 根据dsl的json参数来构建代码</span></span>
<span class="line">        <span class="token class-name">BoolQueryBuilder</span> boolQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// bool里构建must filter等</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>title <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            boolQueryBuilder<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">,</span> title<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>content <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            boolQueryBuilder<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">&quot;content&quot;</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// 排序</span></span>
<span class="line">        <span class="token class-name">ScoreSortBuilder</span> scoreSortBuilder <span class="token operator">=</span> <span class="token class-name">SortBuilders</span><span class="token punctuation">.</span><span class="token function">scoreSort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token class-name">SortOrder</span><span class="token punctuation">.</span><span class="token constant">DESC</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">FieldSortBuilder</span> fieldSortBuilder <span class="token operator">=</span> <span class="token class-name">SortBuilders</span><span class="token punctuation">.</span><span class="token function">fieldSort</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token class-name">SortOrder</span><span class="token punctuation">.</span><span class="token constant">DESC</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// 筛选字段</span></span>
<span class="line">        <span class="token class-name">FetchSourceFilter</span> fetchSourceFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FetchSourceFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;title&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;userId&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// 分页</span></span>
<span class="line">        <span class="token class-name">PageRequest</span> pageRequest <span class="token operator">=</span> <span class="token class-name">PageRequest</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// 构建查询</span></span>
<span class="line">        <span class="token class-name">NativeSearchQuery</span> build <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativeSearchQueryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withQuery</span><span class="token punctuation">(</span>boolQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withPageable</span><span class="token punctuation">(</span>pageRequest<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withSourceFilter</span><span class="token punctuation">(</span>fetchSourceFilter<span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">withSort</span><span class="token punctuation">(</span>scoreSortBuilder<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withSort</span><span class="token punctuation">(</span>fieldSortBuilder<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">SearchHits</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Post</span><span class="token punctuation">&gt;</span></span> search <span class="token operator">=</span> elasticsearchTemplate<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>build<span class="token punctuation">,</span> <span class="token class-name">Post</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="数据同步" tabindex="-1"><a class="header-anchor" href="#数据同步"><span>数据同步</span></a></h2><p>一般情况下，如果做查询搜索功能，使用es来模糊搜索，但是数据是存放在数据库里的，所以需要将<strong>数据库里的数据与es进行同步，保持数据一致性（数据库为主）</strong>。</p><p>首次安装完es，进行全量同步，系统运行时采用增量同步。以下是四种实现方式</p><h3 id="定时任务" tabindex="-1"><a class="header-anchor" href="#定时任务"><span>定时任务</span></a></h3><p>比如每分钟查询前三分钟内修改的数据，然后更新到es里。</p><p>优点：简单易用，无需额外引入中间件。</p><p>缺点：有时间差。</p><p>应用场景：数据短时间内不同步影响不大。</p><h3 id="双写" tabindex="-1"><a class="header-anchor" href="#双写"><span>双写</span></a></h3><p>写数据的时候，将数据写入es，更新、删除数据同理，要开启<strong>事务</strong>（先保证数据库的成功，再去操作es，如果es更新失败，通过<strong>定时任务+日志+告警进行检测和修复</strong>）</p><h3 id="logstash" tabindex="-1"><a class="header-anchor" href="#logstash"><span>LogStash</span></a></h3><p><a href="https://www.elastic.co/guide/en/logstash/7.17/introduction.html#power-of-logstash" target="_blank" rel="noopener noreferrer">LogStach</a>是一个收集和处理数据的管道。</p>`,98)),l("p",null,[s[1]||(s[1]=n("采用LogStash数据同步管道（一般要配合kafka消息队列+beats采集器）,这种数据同步的方式的实现移步")),i(e,{to:"/java/logstash/use.html#%E4%BB%8B%E7%BB%8D"},{default:o(()=>s[0]||(s[0]=[n("logstash章节")])),_:1}),s[2]||(s[2]=n("。"))]),s[4]||(s[4]=a(`<h3 id="订阅数据库流水的同步方式-canal" tabindex="-1"><a class="header-anchor" href="#订阅数据库流水的同步方式-canal"><span>订阅数据库流水的同步方式-Canal</span></a></h3><p><a href="https://github.com/alibaba/canal" target="_blank" rel="noopener noreferrer">canal增量订阅</a></p><p>优点：实时同步、实时性非常强。</p><p>原理：数据库每次修改时，会修改binlog文件，只要监听该文件的修改，就能第一时间得到消息并处理。</p><p><strong>canal伪装成了mysql的从节点，获取主节点给的binlog</strong>。</p><p><img src="https://github.com/zzygeo/picx-images-hosting/raw/master/20241031/canal原理.4uaxtatrlc.webp" alt="canal原理"></p><h2 id="tips" tabindex="-1"><a class="header-anchor" href="#tips"><span>tips</span></a></h2><p>介绍一些elasticsearch使用的知识点。</p><h3 id="关键子句must和filter" tabindex="-1"><a class="header-anchor" href="#关键子句must和filter"><span>关键子句must和filter</span></a></h3><ul><li>must子句的查询会影响文档的<strong>得分</strong>，elasticsearch会计算每个文档与查询的匹配度，根据相似性算法来给文档打分。</li><li>filter不会影响文档的得分，它关心的是文档是否匹配，通常filter在查询性能上更高效，会缓存经常使用的过滤器结果。</li></ul><h3 id="标签高亮" tabindex="-1"><a class="header-anchor" href="#标签高亮"><span>标签高亮</span></a></h3><p>在dsl语法里设置highlight属性，这样查出来的数据里匹配的词组就包上了一层高亮的标签。</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line">GET /_search</span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;content&quot;</span><span class="token operator">:</span> <span class="token string">&quot;kimchy&quot;</span> <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;highlight&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;fields&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;content&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,13))])}const m=p(r,[["render",d],["__file","use.html.vue"]]),h=JSON.parse('{"path":"/java/elasticsearch/use.html","title":"","lang":"zh-CN","frontmatter":{},"headers":[{"level":2,"title":"思路","slug":"思路","link":"#思路","children":[]},{"level":2,"title":"索引","slug":"索引","link":"#索引","children":[{"level":3,"title":"正向索引","slug":"正向索引","link":"#正向索引","children":[]},{"level":3,"title":"倒排索引","slug":"倒排索引","link":"#倒排索引","children":[]}]},{"level":2,"title":"调用方式","slug":"调用方式","link":"#调用方式","children":[{"level":3,"title":"http请求","slug":"http请求","link":"#http请求","children":[]},{"level":3,"title":"kibana","slug":"kibana","link":"#kibana","children":[]},{"level":3,"title":"客户端","slug":"客户端","link":"#客户端","children":[]}]},{"level":2,"title":"使用（DSL）","slug":"使用-dsl","link":"#使用-dsl","children":[{"level":3,"title":"插入数据并创建文档","slug":"插入数据并创建文档","link":"#插入数据并创建文档","children":[]},{"level":3,"title":"查询文档","slug":"查询文档","link":"#查询文档","children":[]},{"level":3,"title":"查询部分字段数据","slug":"查询部分字段数据","link":"#查询部分字段数据","children":[]},{"level":3,"title":"删除文档","slug":"删除文档","link":"#删除文档","children":[]},{"level":3,"title":"查询单条数据","slug":"查询单条数据","link":"#查询单条数据","children":[]},{"level":3,"title":"修改单条数据","slug":"修改单条数据","link":"#修改单条数据","children":[]},{"level":3,"title":"查询表结构","slug":"查询表结构","link":"#查询表结构","children":[]}]},{"level":2,"title":"EQL","slug":"eql","link":"#eql","children":[]},{"level":2,"title":"SQL","slug":"sql","link":"#sql","children":[]},{"level":2,"title":"painless","slug":"painless","link":"#painless","children":[]},{"level":2,"title":"mapping","slug":"mapping","link":"#mapping","children":[{"level":3,"title":"动态mapping","slug":"动态mapping","link":"#动态mapping","children":[]},{"level":3,"title":"显式mapping","slug":"显式mapping","link":"#显式mapping","children":[]}]},{"level":2,"title":"分词器","slug":"分词器","link":"#分词器","children":[{"level":3,"title":"空格分词器","slug":"空格分词器","link":"#空格分词器","children":[]},{"level":3,"title":"标准分词规则","slug":"标准分词规则","link":"#标准分词规则","children":[]},{"level":3,"title":"给特定字段指定分词器","slug":"给特定字段指定分词器","link":"#给特定字段指定分词器","children":[]},{"level":3,"title":"ik分词器（中文）","slug":"ik分词器-中文","link":"#ik分词器-中文","children":[]}]},{"level":2,"title":"打分机制","slug":"打分机制","link":"#打分机制","children":[]},{"level":2,"title":"java里集成","slug":"java里集成","link":"#java里集成","children":[{"level":3,"title":"ElasticsearchRepository方式","slug":"elasticsearchrepository方式","link":"#elasticsearchrepository方式","children":[]},{"level":3,"title":"EleasticsearchTemplate方式","slug":"eleasticsearchtemplate方式","link":"#eleasticsearchtemplate方式","children":[]}]},{"level":2,"title":"数据同步","slug":"数据同步","link":"#数据同步","children":[{"level":3,"title":"定时任务","slug":"定时任务","link":"#定时任务","children":[]},{"level":3,"title":"双写","slug":"双写","link":"#双写","children":[]},{"level":3,"title":"LogStash","slug":"logstash","link":"#logstash","children":[]},{"level":3,"title":"订阅数据库流水的同步方式-Canal","slug":"订阅数据库流水的同步方式-canal","link":"#订阅数据库流水的同步方式-canal","children":[]}]},{"level":2,"title":"tips","slug":"tips","link":"#tips","children":[{"level":3,"title":"关键子句must和filter","slug":"关键子句must和filter","link":"#关键子句must和filter","children":[]},{"level":3,"title":"标签高亮","slug":"标签高亮","link":"#标签高亮","children":[]}]}],"git":{"updatedTime":1731389313000,"contributors":[{"name":"zhongyan.zhou","email":"zhongyan.zhou@eulee.cn","commits":1,"url":"https://github.com/zhongyan.zhou"}]},"filePathRelative":"java/elasticsearch/use.md"}');export{m as comp,h as data};
