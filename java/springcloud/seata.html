<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.18" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (userMode === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (userMode === 'dark' || systemDarkMode) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>西瓜🍉</title><meta name="description" content="西瓜哥学代码">
    <link rel="preload" href="/assets/style-PoWje89h.css" as="style"><link rel="stylesheet" href="/assets/style-PoWje89h.css">
    <link rel="modulepreload" href="/assets/app-BpUWo912.js"><link rel="modulepreload" href="/assets/seata.html-cBZyV1CG.js">
    <link rel="prefetch" href="/assets/index.html-CK0VT3gi.js" as="script"><link rel="prefetch" href="/assets/index.html-suBvf565.js" as="script"><link rel="prefetch" href="/assets/index.html-DQfZyhoD.js" as="script"><link rel="prefetch" href="/assets/introduce.html-B1TX3wjr.js" as="script"><link rel="prefetch" href="/assets/index.html-Co5Rn5_p.js" as="script"><link rel="prefetch" href="/assets/setup.html-uxdW4kKP.js" as="script"><link rel="prefetch" href="/assets/use.html-CuDlTtiW.js" as="script"><link rel="prefetch" href="/assets/use.html-CmAwunh7.js" as="script"><link rel="prefetch" href="/assets/gateway.html-DzPZqhdW.js" as="script"><link rel="prefetch" href="/assets/micrometer_zipkin.html-CuButOGj.js" as="script"><link rel="prefetch" href="/assets/nacos.html-f0_Kyrfi.js" as="script"><link rel="prefetch" href="/assets/openfeign.html-BCmcwVQk.js" as="script"><link rel="prefetch" href="/assets/sentinel.html-eT3KSvVY.js" as="script"><link rel="prefetch" href="/assets/index.html-DX5nHUXN.js" as="script"><link rel="prefetch" href="/assets/404.html-mw-nm_CW.js" as="script"><link rel="prefetch" href="/assets/setupDevtools-7MC2TMWH-Bs_ZB32h.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/"><!----><span class="vp-site-name" aria-hidden="true">西瓜🍉</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><!----><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><!----><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><a class="route-link route-link-active auto-link vp-sidebar-item vp-sidebar-heading collapsible" href="/java/" aria-label="java"><!---->java<!----></a><ul style="display:none;" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item collapsible" href="/java/elasticsearch/setup.html" aria-label="elasticsearch"><!---->elasticsearch<!----></a><ul style="display:none;" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/java/elasticsearch/setup.html" aria-label="安装"><!---->安装<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/java/elasticsearch/use.html" aria-label="简单使用"><!---->简单使用<!----></a><!----></li><!--]--></ul></li><li><a class="route-link auto-link vp-sidebar-item collapsible" href="/java/logstash/use.html" aria-label="logstash"><!---->logstash<!----></a><ul style="display:none;" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/java/logstash/use.html" aria-label="简单使用"><!---->简单使用<!----></a><!----></li><!--]--></ul></li><li><a class="route-link auto-link vp-sidebar-item collapsible" href="/java/timezone/" aria-label="时区问题"><!---->时区问题<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item collapsible" href="/java/springcloud/nacos.html" aria-label="springcloud"><!---->springcloud<!----></a><ul style="display:none;" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/java/springcloud/nacos.html" aria-label="nacos"><!---->nacos<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/java/springcloud/sentinel.html" aria-label="sentinel"><!---->sentinel<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/java/springcloud/openfeign.html" aria-label="openfeign"><!---->openfeign<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/java/springcloud/micrometer_zipkin.html" aria-label="micrometer_zipkin"><!---->micrometer_zipkin<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/java/springcloud/gateway.html" aria-label="gateway"><!---->gateway<!----></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading collapsible" href="/pattern/" aria-label="设计模式"><!---->设计模式<!----></a><ul style="display:none;" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/pattern/introduce.html" aria-label="分类及简单示例"><!---->分类及简单示例<!----></a><!----></li><!--]--></ul></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading collapsible" href="/server/" aria-label="服务器"><!---->服务器<!----></a><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div class="theme-default-content" vp-content><!--[--><!--]--><div><h2 id="seata-server安装" tabindex="-1"><a class="header-anchor" href="#seata-server安装"><span>seata-server安装</span></a></h2><p>先拉取seata-server的镜像。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">$ docker run --name seata-server -p 8091:8091 -p 7091:7091 apache/seata-server:2.2.0</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>复制配置文件到宿主机用来挂载。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">docker cp seata-serve:/seata-server/resources /User/seata/config</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>创建必要的表结构和undo_log表(模式)</p><p><a href="https://github.com/apache/incubator-seata/blob/2.x/script/server/db/mysql.sql" target="_blank" rel="noopener noreferrer">sql地址</a></p><p><a href="https://github.com/apache/incubator-seata/tree/2.x/script/client/at/db" target="_blank" rel="noopener noreferrer">undo_log地址(at)</a></p><p>配置application.yaml</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">server</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">7091</span></span>
<span class="line"></span>
<span class="line"><span class="token key atrule">spring</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">application</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span>server</span>
<span class="line"></span>
<span class="line"><span class="token key atrule">logging</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">config</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>logback<span class="token punctuation">-</span>spring.xml</span>
<span class="line">  <span class="token key atrule">file</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">path</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>log.home<span class="token punctuation">:</span>$<span class="token punctuation">{</span>user.home<span class="token punctuation">}</span>/logs/seata<span class="token punctuation">}</span></span>
<span class="line">  <span class="token key atrule">extend</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">logstash-appender</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">destination</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">4560</span></span>
<span class="line">    <span class="token key atrule">kafka-appender</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">bootstrap-servers</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">9092</span></span>
<span class="line">      <span class="token key atrule">topic</span><span class="token punctuation">:</span> logback_to_logstash</span>
<span class="line"></span>
<span class="line"><span class="token key atrule">console</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">user</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">username</span><span class="token punctuation">:</span> seata</span>
<span class="line">    <span class="token key atrule">password</span><span class="token punctuation">:</span> seata</span>
<span class="line"><span class="token key atrule">seata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">config</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token comment"># support: nacos 、 consul 、 apollo 、 zk  、 etcd3</span></span>
<span class="line">    <span class="token key atrule">type</span><span class="token punctuation">:</span> nacos</span>
<span class="line">    <span class="token key atrule">nacos</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>nacos_host<span class="token punctuation">}</span><span class="token punctuation">:</span>$<span class="token punctuation">{</span>nacos_port<span class="token punctuation">}</span></span>
<span class="line">      <span class="token key atrule">namespace</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">group</span><span class="token punctuation">:</span> SEATA_GROUP</span>
<span class="line">      <span class="token key atrule">context-path</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token comment">##1.The following configuration is for the open source version of Nacos</span></span>
<span class="line">      <span class="token key atrule">username</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>nacos_username<span class="token punctuation">}</span></span>
<span class="line">      <span class="token key atrule">password</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>nacos_password<span class="token punctuation">}</span></span>
<span class="line">      <span class="token comment">##2.The following configuration is for the MSE Nacos on aliyun</span></span>
<span class="line">      <span class="token comment">#access-key:</span></span>
<span class="line">      <span class="token comment">#secret-key:</span></span>
<span class="line">      <span class="token comment">##3.The following configuration is used to deploy on Aliyun ECS or ACK without authentication</span></span>
<span class="line">      <span class="token comment">#ram-role-name:</span></span>
<span class="line">  <span class="token key atrule">registry</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token comment"># support: nacos, eureka, redis, zk, consul, etcd3, sofa</span></span>
<span class="line">    <span class="token key atrule">type</span><span class="token punctuation">:</span> nacos</span>
<span class="line">    <span class="token key atrule">nacos</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">application</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span>server</span>
<span class="line">      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>nacos_host<span class="token punctuation">}</span><span class="token punctuation">:</span>$<span class="token punctuation">{</span>nacos_port<span class="token punctuation">}</span></span>
<span class="line">      <span class="token key atrule">group</span><span class="token punctuation">:</span> SEATA_GROUP</span>
<span class="line">      <span class="token key atrule">namespace</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">cluster</span><span class="token punctuation">:</span> default</span>
<span class="line">      <span class="token key atrule">context-path</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token comment">##1.The following configuration is for the open source version of Nacos</span></span>
<span class="line">      <span class="token key atrule">username</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>nacos_username<span class="token punctuation">}</span></span>
<span class="line">      <span class="token key atrule">password</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>nacos_password<span class="token punctuation">}</span></span>
<span class="line">      <span class="token comment">##2.The following configuration is for the MSE Nacos on aliyun</span></span>
<span class="line">      <span class="token comment">#access-key:</span></span>
<span class="line">      <span class="token comment">#secret-key:</span></span>
<span class="line">      <span class="token comment">##3.The following configuration is used to deploy on Aliyun ECS or ACK without authentication</span></span>
<span class="line">      <span class="token comment">#ram-role-name:</span></span>
<span class="line">  <span class="token key atrule">store</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token comment"># support: file 、 db 、 redis 、 raft</span></span>
<span class="line">    <span class="token key atrule">mode</span><span class="token punctuation">:</span> db</span>
<span class="line">    <span class="token key atrule">db</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">datasource</span><span class="token punctuation">:</span> druid</span>
<span class="line">      <span class="token key atrule">db-type</span><span class="token punctuation">:</span> mysql</span>
<span class="line">      <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver</span>
<span class="line">      <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//$<span class="token punctuation">{</span>mysql_host<span class="token punctuation">}</span><span class="token punctuation">:</span>$<span class="token punctuation">{</span>mysql_port<span class="token punctuation">}</span>/seata_config<span class="token punctuation">?</span>rewriteBatchedStatements=true</span>
<span class="line">      <span class="token key atrule">user</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>mysql_username<span class="token punctuation">}</span></span>
<span class="line">      <span class="token key atrule">password</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>mysql_password<span class="token punctuation">}</span></span>
<span class="line">      <span class="token key atrule">min-conn</span><span class="token punctuation">:</span> <span class="token number">10</span></span>
<span class="line">      <span class="token key atrule">max-conn</span><span class="token punctuation">:</span> <span class="token number">100</span></span>
<span class="line">      <span class="token key atrule">global-table</span><span class="token punctuation">:</span> global_table</span>
<span class="line">      <span class="token key atrule">branch-table</span><span class="token punctuation">:</span> branch_table</span>
<span class="line">      <span class="token key atrule">lock-table</span><span class="token punctuation">:</span> lock_table</span>
<span class="line">      <span class="token key atrule">distributed-lock-table</span><span class="token punctuation">:</span> distributed_lock</span>
<span class="line">      <span class="token key atrule">vgroup-table</span><span class="token punctuation">:</span> vgroup_table</span>
<span class="line">      <span class="token key atrule">query-limit</span><span class="token punctuation">:</span> <span class="token number">1000</span></span>
<span class="line">      <span class="token key atrule">max-wait</span><span class="token punctuation">:</span> <span class="token number">5000</span></span>
<span class="line">  <span class="token comment">#  server:</span></span>
<span class="line">  <span class="token comment">#    service-port: 8091 #If not configured, the default is &#39;${server.port} + 1000&#39;</span></span>
<span class="line">  <span class="token key atrule">security</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">secretKey</span><span class="token punctuation">:</span> SeataSecretKey0c382ef121d778043159209298fd40bf3850a017</span>
<span class="line">    <span class="token key atrule">tokenValidityInMilliseconds</span><span class="token punctuation">:</span> <span class="token number">1800000</span></span>
<span class="line">    <span class="token key atrule">csrf-ignore-urls</span><span class="token punctuation">:</span> /metadata/v1/<span class="token important">**</span></span>
<span class="line">    <span class="token key atrule">ignore</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">urls</span><span class="token punctuation">:</span> /<span class="token punctuation">,</span>/<span class="token important">**/*.css</span><span class="token punctuation">,</span>/<span class="token important">**/*.js</span><span class="token punctuation">,</span>/<span class="token important">**/*.html</span><span class="token punctuation">,</span>/<span class="token important">**/*.map</span><span class="token punctuation">,</span>/<span class="token important">**/*.svg</span><span class="token punctuation">,</span>/<span class="token important">**/*.png</span><span class="token punctuation">,</span>/<span class="token important">**/*.jpeg</span><span class="token punctuation">,</span>/<span class="token important">**/*.ico</span><span class="token punctuation">,</span>/api/v1/auth/login<span class="token punctuation">,</span>/version.json<span class="token punctuation">,</span>/health<span class="token punctuation">,</span>/error<span class="token punctuation">,</span>/vgroup/v1/<span class="token important">**</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>配置docker-compose.yaml</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">services</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">seata-server</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">image</span><span class="token punctuation">:</span> apache/seata<span class="token punctuation">-</span>server<span class="token punctuation">:</span>2.2.0</span>
<span class="line">    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span>server</span>
<span class="line">    <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">&quot;8091:8091&quot;</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">&quot;7091:7091&quot;</span></span>
<span class="line">    <span class="token key atrule">environment</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">nacos_host</span><span class="token punctuation">:</span> nacos</span>
<span class="line">      <span class="token key atrule">nacos_port</span><span class="token punctuation">:</span> <span class="token number">8848</span></span>
<span class="line">      <span class="token key atrule">nacos_username</span><span class="token punctuation">:</span> nacos</span>
<span class="line">      <span class="token key atrule">nacos_password</span><span class="token punctuation">:</span> nacos</span>
<span class="line">      <span class="token key atrule">mysql_host</span><span class="token punctuation">:</span> </span>
<span class="line">      <span class="token key atrule">mysql_port</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">mysql_username</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">mysql_password</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> /Users/zzy/document/docker_data/seata/config<span class="token punctuation">:</span>/seata<span class="token punctuation">-</span>server/resources</span>
<span class="line">    <span class="token key atrule">networks</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> nacos_default</span>
<span class="line"></span>
<span class="line"><span class="token key atrule">networks</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">nacos_default</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">external</span><span class="token punctuation">:</span> true%   </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在nacos里配置信息，<strong>记得group和data-id信息一定写的和client端的一致</strong>，比如SEATA_GROUP和seataServer.properties。</p><div class="language-properties line-numbers-mode" data-highlighter="prismjs" data-ext="properties" data-title="properties"><pre><code><span class="line"><span class="token key attr-name">transport.protocol</span><span class="token punctuation">=</span><span class="token value attr-value">seata</span></span>
<span class="line"><span class="token key attr-name">transport.type</span><span class="token punctuation">=</span><span class="token value attr-value">TCP</span></span>
<span class="line"><span class="token key attr-name">transport.server</span><span class="token punctuation">=</span><span class="token value attr-value">NIO</span></span>
<span class="line"><span class="token key attr-name">transport.heartbeat</span><span class="token punctuation">=</span><span class="token value attr-value">true</span></span>
<span class="line"><span class="token key attr-name">transport.enableTmClientBatchSendRequest</span><span class="token punctuation">=</span><span class="token value attr-value">false</span></span>
<span class="line"><span class="token key attr-name">transport.enableRmClientBatchSendRequest</span><span class="token punctuation">=</span><span class="token value attr-value">true</span></span>
<span class="line"><span class="token key attr-name">transport.enableTcServerBatchSendResponse</span><span class="token punctuation">=</span><span class="token value attr-value">false</span></span>
<span class="line"><span class="token key attr-name">transport.rpcRmRequestTimeout</span><span class="token punctuation">=</span><span class="token value attr-value">30000</span></span>
<span class="line"><span class="token key attr-name">transport.rpcTmRequestTimeout</span><span class="token punctuation">=</span><span class="token value attr-value">30000</span></span>
<span class="line"><span class="token key attr-name">transport.rpcTcRequestTimeout</span><span class="token punctuation">=</span><span class="token value attr-value">30000</span></span>
<span class="line"><span class="token key attr-name">transport.threadFactory.bossThreadPrefix</span><span class="token punctuation">=</span><span class="token value attr-value">NettyBoss</span></span>
<span class="line"><span class="token key attr-name">transport.threadFactory.workerThreadPrefix</span><span class="token punctuation">=</span><span class="token value attr-value">NettyServerNIOWorker</span></span>
<span class="line"><span class="token key attr-name">transport.threadFactory.serverExecutorThreadPrefix</span><span class="token punctuation">=</span><span class="token value attr-value">NettyServerBizHandler</span></span>
<span class="line"><span class="token key attr-name">transport.threadFactory.shareBossWorker</span><span class="token punctuation">=</span><span class="token value attr-value">false</span></span>
<span class="line"><span class="token key attr-name">transport.threadFactory.clientSelectorThreadPrefix</span><span class="token punctuation">=</span><span class="token value attr-value">NettyClientSelector</span></span>
<span class="line"><span class="token key attr-name">transport.threadFactory.clientSelectorThreadSize</span><span class="token punctuation">=</span><span class="token value attr-value">1</span></span>
<span class="line"><span class="token key attr-name">transport.threadFactory.clientWorkerThreadPrefix</span><span class="token punctuation">=</span><span class="token value attr-value">NettyClientWorkerThread</span></span>
<span class="line"><span class="token key attr-name">transport.threadFactory.bossThreadSize</span><span class="token punctuation">=</span><span class="token value attr-value">1</span></span>
<span class="line"><span class="token key attr-name">transport.threadFactory.workerThreadSize</span><span class="token punctuation">=</span><span class="token value attr-value">default</span></span>
<span class="line"><span class="token key attr-name">transport.shutdown.wait</span><span class="token punctuation">=</span><span class="token value attr-value">3</span></span>
<span class="line"><span class="token key attr-name">transport.serialization</span><span class="token punctuation">=</span><span class="token value attr-value">seata</span></span>
<span class="line"><span class="token key attr-name">transport.compressor</span><span class="token punctuation">=</span><span class="token value attr-value">none</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">#Transaction routing rules configuration, only for the client</span></span>
<span class="line"><span class="token key attr-name">service.vgroupMapping.default_tx_group</span><span class="token punctuation">=</span><span class="token value attr-value">default</span></span>
<span class="line"><span class="token comment">#If you use a registry, you can ignore it</span></span>
<span class="line"><span class="token key attr-name">service.default.grouplist</span><span class="token punctuation">=</span><span class="token value attr-value">127.0.0.1:8091</span></span>
<span class="line"><span class="token key attr-name">service.disableGlobalTransaction</span><span class="token punctuation">=</span><span class="token value attr-value">false</span></span>
<span class="line"></span>
<span class="line"><span class="token key attr-name">client.metadataMaxAgeMs</span><span class="token punctuation">=</span><span class="token value attr-value">30000</span></span>
<span class="line"><span class="token comment">#Transaction rule configuration, only for the client</span></span>
<span class="line"><span class="token key attr-name">client.rm.asyncCommitBufferLimit</span><span class="token punctuation">=</span><span class="token value attr-value">10000</span></span>
<span class="line"><span class="token key attr-name">client.rm.lock.retryInterval</span><span class="token punctuation">=</span><span class="token value attr-value">10</span></span>
<span class="line"><span class="token key attr-name">client.rm.lock.retryTimes</span><span class="token punctuation">=</span><span class="token value attr-value">30</span></span>
<span class="line"><span class="token key attr-name">client.rm.lock.retryPolicyBranchRollbackOnConflict</span><span class="token punctuation">=</span><span class="token value attr-value">true</span></span>
<span class="line"><span class="token key attr-name">client.rm.reportRetryCount</span><span class="token punctuation">=</span><span class="token value attr-value">5</span></span>
<span class="line"><span class="token key attr-name">client.rm.tableMetaCheckEnable</span><span class="token punctuation">=</span><span class="token value attr-value">true</span></span>
<span class="line"><span class="token key attr-name">client.rm.tableMetaCheckerInterval</span><span class="token punctuation">=</span><span class="token value attr-value">60000</span></span>
<span class="line"><span class="token key attr-name">client.rm.sqlParserType</span><span class="token punctuation">=</span><span class="token value attr-value">druid</span></span>
<span class="line"><span class="token key attr-name">client.rm.reportSuccessEnable</span><span class="token punctuation">=</span><span class="token value attr-value">false</span></span>
<span class="line"><span class="token key attr-name">client.rm.sagaBranchRegisterEnable</span><span class="token punctuation">=</span><span class="token value attr-value">false</span></span>
<span class="line"><span class="token key attr-name">client.rm.sagaJsonParser</span><span class="token punctuation">=</span><span class="token value attr-value">fastjson</span></span>
<span class="line"><span class="token key attr-name">client.rm.tccActionInterceptorOrder</span><span class="token punctuation">=</span><span class="token value attr-value">-2147482648</span></span>
<span class="line"><span class="token key attr-name">client.rm.sqlParserType</span><span class="token punctuation">=</span><span class="token value attr-value">druid</span></span>
<span class="line"><span class="token key attr-name">client.tm.commitRetryCount</span><span class="token punctuation">=</span><span class="token value attr-value">5</span></span>
<span class="line"><span class="token key attr-name">client.tm.rollbackRetryCount</span><span class="token punctuation">=</span><span class="token value attr-value">5</span></span>
<span class="line"><span class="token key attr-name">client.tm.defaultGlobalTransactionTimeout</span><span class="token punctuation">=</span><span class="token value attr-value">60000</span></span>
<span class="line"><span class="token key attr-name">client.tm.degradeCheck</span><span class="token punctuation">=</span><span class="token value attr-value">false</span></span>
<span class="line"><span class="token key attr-name">client.tm.degradeCheckAllowTimes</span><span class="token punctuation">=</span><span class="token value attr-value">10</span></span>
<span class="line"><span class="token key attr-name">client.tm.degradeCheckPeriod</span><span class="token punctuation">=</span><span class="token value attr-value">2000</span></span>
<span class="line"><span class="token key attr-name">client.tm.interceptorOrder</span><span class="token punctuation">=</span><span class="token value attr-value">-2147482648</span></span>
<span class="line"><span class="token key attr-name">client.undo.dataValidation</span><span class="token punctuation">=</span><span class="token value attr-value">true</span></span>
<span class="line"><span class="token key attr-name">client.undo.logSerialization</span><span class="token punctuation">=</span><span class="token value attr-value">jackson</span></span>
<span class="line"><span class="token key attr-name">client.undo.onlyCareUpdateColumns</span><span class="token punctuation">=</span><span class="token value attr-value">true</span></span>
<span class="line"><span class="token key attr-name">server.undo.logSaveDays</span><span class="token punctuation">=</span><span class="token value attr-value">7</span></span>
<span class="line"><span class="token key attr-name">server.undo.logDeletePeriod</span><span class="token punctuation">=</span><span class="token value attr-value">86400000</span></span>
<span class="line"><span class="token key attr-name">client.undo.logTable</span><span class="token punctuation">=</span><span class="token value attr-value">undo_log</span></span>
<span class="line"><span class="token key attr-name">client.undo.compress.enable</span><span class="token punctuation">=</span><span class="token value attr-value">true</span></span>
<span class="line"><span class="token key attr-name">client.undo.compress.type</span><span class="token punctuation">=</span><span class="token value attr-value">zip</span></span>
<span class="line"><span class="token key attr-name">client.undo.compress.threshold</span><span class="token punctuation">=</span><span class="token value attr-value">64k</span></span>
<span class="line"><span class="token comment">#For TCC transaction mode</span></span>
<span class="line"><span class="token key attr-name">tcc.fence.logTableName</span><span class="token punctuation">=</span><span class="token value attr-value">tcc_fence_log</span></span>
<span class="line"><span class="token key attr-name">tcc.fence.cleanPeriod</span><span class="token punctuation">=</span><span class="token value attr-value">1h</span></span>
<span class="line"><span class="token comment"># You can choose from the following options: fastjson, jackson, gson</span></span>
<span class="line"><span class="token key attr-name">tcc.contextJsonParserType</span><span class="token punctuation">=</span><span class="token value attr-value">fastjson</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">#Log rule configuration, for client and server</span></span>
<span class="line"><span class="token key attr-name">log.exceptionRate</span><span class="token punctuation">=</span><span class="token value attr-value">100</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">#Transaction storage configuration, only for the server. The file, db, and redis configuration values are optional.</span></span>
<span class="line"><span class="token key attr-name">store.mode</span><span class="token punctuation">=</span><span class="token value attr-value">db</span></span>
<span class="line"><span class="token key attr-name">store.lock.mode</span><span class="token punctuation">=</span><span class="token value attr-value">db</span></span>
<span class="line"><span class="token key attr-name">store.session.mode</span><span class="token punctuation">=</span><span class="token value attr-value">db</span></span>
<span class="line"><span class="token comment">#Used for password encryption</span></span>
<span class="line"><span class="token key attr-name">store.publicKey</span><span class="token punctuation">=</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">#These configurations are required if the `store mode` is `db`. If `store.mode,store.lock.mode,store.session.mode` are not equal to `db`, you can remove the configuration block.</span></span>
<span class="line"><span class="token key attr-name">store.db.datasource</span><span class="token punctuation">=</span><span class="token value attr-value">druid</span></span>
<span class="line"><span class="token key attr-name">store.db.dbType</span><span class="token punctuation">=</span><span class="token value attr-value">mysql</span></span>
<span class="line"><span class="token key attr-name">store.db.driverClassName</span><span class="token punctuation">=</span><span class="token value attr-value">com.mysql.cj.jdbc.Driver</span></span>
<span class="line"><span class="token key attr-name">store.db.url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://***:***/seata_config?useUnicode=true&amp;rewriteBatchedStatements=true</span></span>
<span class="line"><span class="token key attr-name">store.db.user</span><span class="token punctuation">=</span></span>
<span class="line"><span class="token key attr-name">store.db.password</span><span class="token punctuation">=</span></span>
<span class="line"><span class="token key attr-name">store.db.minConn</span><span class="token punctuation">=</span><span class="token value attr-value">5</span></span>
<span class="line"><span class="token key attr-name">store.db.maxConn</span><span class="token punctuation">=</span><span class="token value attr-value">30</span></span>
<span class="line"><span class="token key attr-name">store.db.globalTable</span><span class="token punctuation">=</span><span class="token value attr-value">global_table</span></span>
<span class="line"><span class="token key attr-name">store.db.branchTable</span><span class="token punctuation">=</span><span class="token value attr-value">branch_table</span></span>
<span class="line"><span class="token key attr-name">store.db.distributedLockTable</span><span class="token punctuation">=</span><span class="token value attr-value">distributed_lock</span></span>
<span class="line"><span class="token key attr-name">store.db.vgroupTable</span><span class="token punctuation">=</span><span class="token value attr-value">vgroup-table</span></span>
<span class="line"><span class="token key attr-name">store.db.queryLimit</span><span class="token punctuation">=</span><span class="token value attr-value">100</span></span>
<span class="line"><span class="token key attr-name">store.db.lockTable</span><span class="token punctuation">=</span><span class="token value attr-value">lock_table</span></span>
<span class="line"><span class="token key attr-name">store.db.maxWait</span><span class="token punctuation">=</span><span class="token value attr-value">5000</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">#Transaction rule configuration, only for the server</span></span>
<span class="line"><span class="token key attr-name">server.recovery.committingRetryPeriod</span><span class="token punctuation">=</span><span class="token value attr-value">1000</span></span>
<span class="line"><span class="token key attr-name">server.recovery.asynCommittingRetryPeriod</span><span class="token punctuation">=</span><span class="token value attr-value">1000</span></span>
<span class="line"><span class="token key attr-name">server.recovery.rollbackingRetryPeriod</span><span class="token punctuation">=</span><span class="token value attr-value">1000</span></span>
<span class="line"><span class="token key attr-name">server.recovery.timeoutRetryPeriod</span><span class="token punctuation">=</span><span class="token value attr-value">1000</span></span>
<span class="line"><span class="token key attr-name">server.maxCommitRetryTimeout</span><span class="token punctuation">=</span><span class="token value attr-value">-1</span></span>
<span class="line"><span class="token key attr-name">server.maxRollbackRetryTimeout</span><span class="token punctuation">=</span><span class="token value attr-value">-1</span></span>
<span class="line"><span class="token key attr-name">server.rollbackFailedUnlockEnable</span><span class="token punctuation">=</span><span class="token value attr-value">false</span></span>
<span class="line"><span class="token key attr-name">server.distributedLockExpireTime</span><span class="token punctuation">=</span><span class="token value attr-value">10000</span></span>
<span class="line"><span class="token key attr-name">server.session.branchAsyncQueueSize</span><span class="token punctuation">=</span><span class="token value attr-value">5000</span></span>
<span class="line"><span class="token key attr-name">server.session.enableBranchAsyncRemove</span><span class="token punctuation">=</span><span class="token value attr-value">false</span></span>
<span class="line"><span class="token key attr-name">server.enableParallelRequestHandle</span><span class="token punctuation">=</span><span class="token value attr-value">true</span></span>
<span class="line"><span class="token key attr-name">server.enableParallelHandleBranch</span><span class="token punctuation">=</span><span class="token value attr-value">false</span></span>
<span class="line"><span class="token key attr-name">server.applicationDataLimit</span><span class="token punctuation">=</span><span class="token value attr-value">64000</span></span>
<span class="line"><span class="token key attr-name">server.applicationDataLimitCheck</span><span class="token punctuation">=</span><span class="token value attr-value">false</span></span>
<span class="line"></span>
<span class="line"><span class="token key attr-name">server.raft.server-addr</span><span class="token punctuation">=</span><span class="token value attr-value">127.0.0.1:7091,127.0.0.1:7092,127.0.0.1:7093</span></span>
<span class="line"><span class="token key attr-name">server.raft.snapshotInterval</span><span class="token punctuation">=</span><span class="token value attr-value">600</span></span>
<span class="line"><span class="token key attr-name">server.raft.applyBatch</span><span class="token punctuation">=</span><span class="token value attr-value">32</span></span>
<span class="line"><span class="token key attr-name">server.raft.maxAppendBufferSize</span><span class="token punctuation">=</span><span class="token value attr-value">262144</span></span>
<span class="line"><span class="token key attr-name">server.raft.maxReplicatorInflightMsgs</span><span class="token punctuation">=</span><span class="token value attr-value">256</span></span>
<span class="line"><span class="token key attr-name">server.raft.disruptorBufferSize</span><span class="token punctuation">=</span><span class="token value attr-value">16384</span></span>
<span class="line"><span class="token key attr-name">server.raft.electionTimeoutMs</span><span class="token punctuation">=</span><span class="token value attr-value">2000</span></span>
<span class="line"><span class="token key attr-name">server.raft.reporterEnabled</span><span class="token punctuation">=</span><span class="token value attr-value">false</span></span>
<span class="line"><span class="token key attr-name">server.raft.reporterInitialDelay</span><span class="token punctuation">=</span><span class="token value attr-value">60</span></span>
<span class="line"><span class="token key attr-name">server.raft.serialization</span><span class="token punctuation">=</span><span class="token value attr-value">jackson</span></span>
<span class="line"><span class="token key attr-name">server.raft.compressor</span><span class="token punctuation">=</span><span class="token value attr-value">none</span></span>
<span class="line"><span class="token key attr-name">server.raft.sync</span><span class="token punctuation">=</span><span class="token value attr-value">true</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token comment">#Metrics configuration, only for the server</span></span>
<span class="line"><span class="token key attr-name">metrics.enabled</span><span class="token punctuation">=</span><span class="token value attr-value">true</span></span>
<span class="line"><span class="token key attr-name">metrics.registryType</span><span class="token punctuation">=</span><span class="token value attr-value">compact</span></span>
<span class="line"><span class="token key attr-name">metrics.exporterList</span><span class="token punctuation">=</span><span class="token value attr-value">prometheus</span></span>
<span class="line"><span class="token key attr-name">metrics.exporterPrometheusPort</span><span class="token punctuation">=</span><span class="token value attr-value">9898</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在client端配置：</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">seata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">config</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">type</span><span class="token punctuation">:</span> nacos</span>
<span class="line">    <span class="token key atrule">nacos</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span></span>
<span class="line">      <span class="token key atrule">namespace</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">group</span><span class="token punctuation">:</span> SEATA_GROUP</span>
<span class="line">      <span class="token key atrule">username</span><span class="token punctuation">:</span> nacos</span>
<span class="line">      <span class="token key atrule">password</span><span class="token punctuation">:</span> nacos</span>
<span class="line">      <span class="token key atrule">data-id</span><span class="token punctuation">:</span> seataServer.properties</span>
<span class="line">  <span class="token key atrule">tx-service-group</span><span class="token punctuation">:</span> default_tx_group</span>
<span class="line">  <span class="token key atrule">service</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">vgroup-mapping</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">default_tx_group</span><span class="token punctuation">:</span> default <span class="token comment"># 事务组与TC服务集群的映射关系</span></span>
<span class="line">      <span class="token key atrule">grouplist</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">default</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>seata.address<span class="token punctuation">:</span>127.0.0.1<span class="token punctuation">}</span><span class="token punctuation">:</span>$<span class="token punctuation">{</span>seata.port<span class="token punctuation">:</span><span class="token number">8091</span><span class="token punctuation">}</span></span>
<span class="line">  <span class="token key atrule">data-source-proxy-mode</span><span class="token punctuation">:</span> AT</span>
<span class="line">  <span class="token key atrule">application-id</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span>server</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="at模式" tabindex="-1"><a class="header-anchor" href="#at模式"><span>at模式</span></a></h2><p>两阶段提交协议的演变： 一阶段，业务数据和回滚日志记录在同一个本地事务中<strong>提交</strong>，申请全局锁（tc管理，记录xid、表名、执行的主键），<strong>释放db锁和连接资源。</strong></p><p>二阶段：</p><p>提交异步化，非常快速地完成，释放全局锁，删除undo_log。</p><p>回滚，通过一阶段的<strong>回滚日志进行反向补偿</strong>。</p><p>具体来说：</p><h3 id="一阶段" tabindex="-1"><a class="header-anchor" href="#一阶段"><span>一阶段</span></a></h3><p>在一阶段，seata会拦截业务sql。</p><p>解析sql的含义，<strong>找到业务sql要更新的业务数据，在业务数据被更新之前，将其保存为before image</strong>。</p><p>执行业务sql更新业务数据，<strong>在业务数据更新之后，将其保存为after image</strong>，这里会直接提交分支事务，所以性能比较高，但是可能出现安全性问题。为了解决这个问题，引入了全局锁，即由TC记录当前正在操作某行数据的事务，该事务持有全局锁，具备执行权力，TC记录包含了事务的xid、操作的表名table，执行的主建pk。</p><p>以上操作全部在一个数据库事务里完成，保证了操作的原子性。</p><h3 id="二阶段" tabindex="-1"><a class="header-anchor" href="#二阶段"><span>二阶段</span></a></h3><p>在二阶段，分为两种情况。</p><p>顺利提交，因为业务sql在一阶段已经提交到了数据库，所以seata框架只需<strong>将一阶段保存的快照数据和全局锁删掉，完成数据清理</strong>即可。</p><p>异常数据，需要回滚一阶段已经执行的业务sql，还原业务数据。回滚方式便是<strong>用before image还原业务数据</strong>。</p><p>这里又分两种情况，事务都被seata管理和事务没有全部被seata管理。</p><p>如果都被seata管理，<strong>比如a事务获取x数据的全局锁，尝试获取y数据的全局锁，b事务获取y数据的锁，尝试获取x数据的全局锁，此时相互持有对方的锁，造成了死锁。又或者某个事务长时间占用某个锁或者多个锁，导致其他事务迟迟拿不到锁无法执行，也会出现死锁</strong>，因此seata引入了锁超时机制，重试获取全局锁，达到一定次数，直接抛出异常，回滚当前事务。</p><p>如果有事务没有被seata管理，那么它也不需要获取全局锁了，由于at模式下，分支事务是直接提交的，因此该事务直接就能获取db锁进行修改，如果seata全局事务回滚，有可能将不归seata管理的事务操作覆盖了，通用导致了脏写，因此seata在还原之前还需要<strong>校验脏写</strong>，对比数据库当前数据和after image，如果两份数据完全一致就说明<strong>没有脏写</strong>，可以还原业务数据，如果不一致就说明脏写，<strong>出现脏写就需要转人工处理</strong>。</p></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="vp-meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: zhongyan.zhou@eulee.cn">zhongyan.zhou</span><!----><!--]--><!--]--></span></div></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-BpUWo912.js" defer></script>
  </body>
</html>
